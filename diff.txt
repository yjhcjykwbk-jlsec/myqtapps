0a1,41
> /****************************************************************************
> **
> ** Copyright (C) 2010 Nokia Corporation and/or its subsidiary(-ies).
> ** All rights reserved.
> ** Contact: Nokia Corporation (qt-info@nokia.com)
> **
> ** This file is part of the demonstration applications of the Qt Toolkit.
> **
> ** $QT_BEGIN_LICENSE:LGPL$
> ** Commercial Usage
> ** Licensees holding valid Qt Commercial licenses may use this file in
> ** accordance with the Qt Commercial License Agreement provided with the
> ** Software or, alternatively, in accordance with the terms contained in
> ** a written agreement between you and Nokia.
> **
> ** GNU Lesser General Public License Usage
> ** Alternatively, this file may be used under the terms of the GNU Lesser
> ** General Public License version 2.1 as published by the Free Software
> ** Foundation and appearing in the file LICENSE.LGPL included in the
> ** packaging of this file.  Please review the following information to
> ** ensure the GNU Lesser General Public License version 2.1 requirements
> ** will be met: http://www.gnu.org/licenses/old-licenses/lgpl-2.1.html.
> **
> ** In addition, as a special exception, Nokia gives you certain additional
> ** rights.  These rights are described in the Nokia Qt LGPL Exception
> ** version 1.1, included in the file LGPL_EXCEPTION.txt in this package.
> **
> ** GNU General Public License Usage
> ** Alternatively, this file may be used under the terms of the GNU
> ** General Public License version 3.0 as published by the Free Software
> ** Foundation and appearing in the file LICENSE.GPL included in the
> ** packaging of this file.  Please review the following information to
> ** ensure the GNU General Public License version 3.0 requirements will be
> ** met: http://www.gnu.org/copyleft/gpl.html.
> **
> ** If you have questions regarding the use of this file, please contact
> ** Nokia at qt-info@nokia.com.
> ** $QT_END_LICENSE$
> **
> ****************************************************************************/
> 
1a43
> 
4,5d45
< #include <QTextLine>
< #include <QStackedLayout>
28,30c68,69
< #include <QScrollArea>
< #include <QTextDocumentFragment>
< QT_FORWARD_DECLARE_CLASS(QTextDocumentFragment)
---
> #include <QtXml>
> 
37,164d75
< //init the canvas at which page
< //pn=0 to N-1
< void TextEdit::loadCanvas(){
<   canvas->reload();
<   cout<<"line["<<curPn<<"]:"<<lines[curPn].size();
<   for(int i=0;i<lines[curPn].size();i++){
<     canvas->paintLine(lines[curPn][i]);
<   }
< }
< void iniLineMargin(QTextEdit *textEdit){
<   QTextDocument* doc=textEdit->document();
<   int t=0;
<   for(QTextBlock it = doc->begin(); it != doc->end();t++,it = it.next())
<   {
<     QTextCursor textCursor=QTextCursor(it);
<     QTextBlockFormat textBlockFormat = it.blockFormat();
<     textBlockFormat.setBottomMargin(0);//set line margin
<     textBlockFormat.setTopMargin(0);
<     cout<<"#"<<t;
<     cout<<textCursor.block().text();
<     textCursor.setBlockFormat(textBlockFormat);
< //    textEdit->setTextCursor(textCursor);
<   }
< }
< //jump to page s
< //and init the canvas at page s
< //s=0 to N-1
< void TextEdit::pageChanged(int s){
<   if(s>docs.size()||s<1) return;
<   curPn=s-1;
<   textEdit->setDocument(docs[s-1]);
<   iniFontSize();
<   iniLineMargin(textEdit);
<   loadCanvas();
< }
< void TextEdit::pageChanged(QString s){
<   return pageChanged(s.toInt());
< }
< //jump to next page
< void TextEdit::nextPage(){
<   int t=curPn+1;
<   if(t>docs.size()) return;
<   pageChanged(t);
< }
< //jump to previous page
< void TextEdit::prevPage(){
<   int t=curPn-1;
<   if(t<1) return;
<   pageChanged(t);
< }
< //hide the toolbar
< void TextEdit::hideToolBar(){
<   if(toolBar!=NULL)
<     toolBar->toggleViewAction();
< }
< //init font size
< void TextEdit::iniFontSize(){
<   cout<<"#textedit::inifontsize";
<   qreal pointSize = FONTSIZE;
<   QTextCharFormat fmt;
<   fmt.setFontPointSize(pointSize);
<   QTextCursor cursor = textEdit->textCursor();
<   cursor.select(QTextCursor::Document);
<   cursor.mergeCharFormat(fmt);
<   hideText();
<   //  textEdit->setCurrentCharFormat(fmt);
< }
< //hide the text of the textedit
< void TextEdit::hideText(){
<   QColor col = FONTCOLOR;
<   QTextCharFormat fmt;
<   fmt.setForeground(col);
<   QTextCursor cursor = textEdit->textCursor();
<   cursor.select(QTextCursor::Document);
<   cursor.mergeCharFormat(fmt);
<   textEdit->setCurrentCharFormat(fmt);
< }
< //divide to pages
< //note: everytime the divide result is the same
< void TextEdit::dividePages(){
<   iniFontSize();
<   iniLineMargin(textEdit);
<   QTextDocument* doc=textEdit->document();
<   cout<<doc->textWidth()<<","<<doc->pageCount()<<","<<doc->pageSize();
<   QTextBlock block=doc->begin();
<   QString str="";
<   int pageHeight=4;
<   while(true){
<     //cout<<"";
<     //cout<<"block "<<block.blockNumber()<<"\tposx:"<<block.layout()->position().x()<<"\tposy:"<<block.layout()->position().y();
<     //cout<<block.text();
<     QTextLayout* layout=block.layout();
< //    if(layout==NULL) return;
<     int i=0;
<     //for(;i<=blockLength;i++){
<     for(;i<layout->lineCount();i++){
<       //QTextLine layoutLine=layout->lineForTextPosition(i);
<       QTextLine layoutLine=layout->lineAt(i);
<       int lineTextStart=layoutLine.textStart();
<       int lineTextLength=layoutLine.textLength();
<       int lineHeight=layoutLine.height();
<       if(pageHeight+lineHeight>PAGEHEIGHT-4){ //new page
<         docs.append(new QTextDocument(str));
<         str=block.text().mid(lineTextStart,lineTextLength)+'\n';
<         pageHeight=lineHeight+4;
<       }
<       else{
<         str.append(block.text().mid(lineTextStart,lineTextLength)+'\n');
<         //cout<<layoutLine.lineNumber()<<","<<layoutLine.rect()<<","<<layoutLine.position()
<         //<<","<<layoutLine.textStart()<<","<<layoutLine.textLength()<<":"<<block.text().mid(lineTextStart,lineTextLength);
<         pageHeight+=lineHeight;
<       }
<       // if(i==layout->lineCount()-1) str+="\n";
<     }
<     block=block.next();
<     if(!block.isValid()) break;
<   }
<   if(str!=""||docs.size()<=0) docs.append(new QTextDocument(str));
<   //init the lines , which is used by our canvas
<   lines.resize(0);
<   lines.resize(docs.size());
<   comboPn->clear();
<   for(int size=1;size<=docs.size();size++)
<     comboPn->addItem(QString::number(size));
<   //show the first page at first
<   pageChanged(1);
<   cout<<"dividePages end";
< }
166c77
<   : QMainWindow(parent)
---
>     : QMainWindow(parent)
168,263c79,129
<   setToolButtonStyle(Qt::ToolButtonFollowStyle);
<   setupFileActions();
<   setupEditActions();
<   setupTextActions();
< 
<   //create the text edit widget
<   textEdit = new QTextEdit(this);
<   connect(textEdit, SIGNAL(currentCharFormatChanged(QTextCharFormat)),
<           this, SLOT(currentCharFormatChanged(QTextCharFormat)));
<   connect(textEdit, SIGNAL(cursorPositionChanged()),
<           this, SLOT(cursorPositionChanged()));
<   //connect(textEdit,SIGNAL(textChanged()),this,SLOT(dividePages()));
< 
<   //setCentralWidget(textEdit);
<   //blank=new Blank(this);
<   //setCentralWidget(blank);
< 
<   //set textedit as fix size
<   textEdit->setFixedSize(QSize(A4WIDTH,A4HEIGHT));
< 
<   //set textedit's background opacity =0
<   //  textEdit->setBackgroundRole(QPalette::Light);
<   //  TextEdit.setStyleSheet("<");
<   //  textEdit->setWindowOpacity(0.3);
<   //  textEdit->hide();
<   QPalette pl = textEdit->palette();
<   pl.setBrush(QPalette::Base,QBrush(QColor(255,0,0,0)));
<   textEdit->setPalette(pl);
< 
<   //create a transparent canvas and put it on the top of textEdit
<   canvas =new MyCanvas(A4WIDTH,A4HEIGHT,this);
<   canvas->setFixedSize(QSize(A4WIDTH,A4HEIGHT));
<   canvas->setStyleSheet(QString::fromUtf8("border:1px solid #eeeeee;"));
< 
<   //create a scrollarea contains the widgets as canvas and textedit
<   QScrollArea* scrollArea = new QScrollArea;
<   scrollArea->setFixedSize(QSize(A4WIDTH,A4HEIGHT));
<   scrollArea->setBackgroundRole(QPalette::Light);
< 
<   //set layout of the scrollarea which contains canvas and textedit
<   QStackedLayout *stackedLayout = new QStackedLayout;
<   stackedLayout->addWidget(canvas);
<   stackedLayout->addWidget(textEdit);
<   textEdit->setAlignment(Qt::AlignHCenter);
<   stackedLayout->setStackingMode(QStackedLayout::StackAll);
<   scrollArea->setLayout(stackedLayout);
< 
<   //QHBoxLayout* hLayout=new QHBoxLayout();
<   //hLayout->addWidget(textEdit);
<   //hLayout->addWidget(canvas);
<   //scrollArea->setLayout(hLayout);
< 
<   scrollArea->setAlignment(Qt::AlignCenter);
<   scrollArea->setStyleSheet(QString::fromUtf8("border:1px dashed #777;"));
< 
<   QScrollArea* outerScrollArea = new QScrollArea;
<   outerScrollArea->setFixedSize(QSize(A4WIDTH+200,A4HEIGHT+20));
<   outerScrollArea->setBackgroundRole(QPalette::Light);
<   outerScrollArea->setWidget(scrollArea);
<   outerScrollArea->setAlignment(Qt::AlignCenter);
<   setCentralWidget(outerScrollArea);
<   //@invalidate codes
<   //after canvas handle the mouse-drag event, emit it to the edittext for farther handling
<   //connect(canvas,SIGNAL(mouseMoveSig(QMouseEvent*)),this,SLOT(onMouseMove(QMouseEvent*)));
<   //connect(canvas,SIGNAL(mouseMoveSig(QMouseEvent*)),textEdit,SLOT(mouseMoveEvent(QMouseEvent*)));
<   //connect(canvas,SIGNAL(mouseMoveSig(QMouseEvent*)),textEdit,SLOT(cursorPositionChanged(QMouseEvent*)));
<   //connect(this,SIGNAL(mouseMoveSig(QMouseEvent*)),canvas,SLOT(mouseMoveSlot(QMouseEvent*)));
<   //connect(textEdit,SIGNAL(mouseMoveEvent(QMouseEvent*)),canvas,SLOT(mouseMoveSlot(QMouseEvent*)));
< 
<   setCurrentFileName(QString());
<   fontChanged(textEdit->font());
<   colorChanged(textEdit->textColor());
<   alignmentChanged(textEdit->alignment());
<   connect(textEdit->document(), SIGNAL(modificationChanged(bool)),
<           actionSave, SLOT(setEnabled(bool)));
<   connect(textEdit->document(), SIGNAL(modificationChanged(bool)),
<           this, SLOT(setWindowModified(bool)));
<   connect(textEdit->document(), SIGNAL(undoAvailable(bool)),
<           actionUndo, SLOT(setEnabled(bool)));
<   connect(textEdit->document(), SIGNAL(redoAvailable(bool)),
<           actionRedo, SLOT(setEnabled(bool)));
< 
<   setWindowModified(textEdit->document()->isModified());
<   actionSave->setEnabled(textEdit->document()->isModified());
<   actionUndo->setEnabled(textEdit->document()->isUndoAvailable());
<   actionRedo->setEnabled(textEdit->document()->isRedoAvailable());
< 
<   connect(actionUndo, SIGNAL(triggered()), textEdit, SLOT(undo()));
<   connect(actionRedo, SIGNAL(triggered()), textEdit, SLOT(redo()));
< 
<   actionCut->setEnabled(false);
<   actionCopy->setEnabled(false);
< 
<   connect(actionCut, SIGNAL(triggered()), textEdit, SLOT(cut()));
<   connect(actionCopy, SIGNAL(triggered()), textEdit, SLOT(copy()));
<   connect(actionPaste, SIGNAL(triggered()), textEdit, SLOT(paste()));
---
>     setToolButtonStyle(Qt::ToolButtonFollowStyle);
>     setupFileActions();
>     setupEditActions();
>     setupTextActions();
> 
>     {
>         QMenu *helpMenu = new QMenu(tr("Help"), this);
>         menuBar()->addMenu(helpMenu);
>         helpMenu->addAction(tr("About"), this, SLOT(about()));
>         helpMenu->addAction(tr("About &Qt"), qApp, SLOT(aboutQt()));
>     }
> 
> 
>     //why use this
>     textEdit = new QTextEdit(this);
>     connect(textEdit, SIGNAL(currentCharFormatChanged(QTextCharFormat)),
>             this, SLOT(currentCharFormatChanged(QTextCharFormat)));
>     connect(textEdit, SIGNAL(cursorPositionChanged()),
>             this, SLOT(cursorPositionChanged()));
> 
>     setCentralWidget(textEdit);
>     textEdit->setFocus();
>     setCurrentFileName(QString());
> 
>     fontChanged(textEdit->font());
>     colorChanged(textEdit->textColor());
>     alignmentChanged(textEdit->alignment());
> 
>     connect(textEdit->document(), SIGNAL(modificationChanged(bool)),
>             actionSave, SLOT(setEnabled(bool)));
>     connect(textEdit->document(), SIGNAL(modificationChanged(bool)),
>             this, SLOT(setWindowModified(bool)));
>     connect(textEdit->document(), SIGNAL(undoAvailable(bool)),
>             actionUndo, SLOT(setEnabled(bool)));
>     connect(textEdit->document(), SIGNAL(redoAvailable(bool)),
>             actionRedo, SLOT(setEnabled(bool)));
> 
>     setWindowModified(textEdit->document()->isModified());
>     actionSave->setEnabled(textEdit->document()->isModified());
>     actionUndo->setEnabled(textEdit->document()->isUndoAvailable());
>     actionRedo->setEnabled(textEdit->document()->isRedoAvailable());
> 
>     connect(actionUndo, SIGNAL(triggered()), textEdit, SLOT(undo()));
>     connect(actionRedo, SIGNAL(triggered()), textEdit, SLOT(redo()));
> 
>     actionCut->setEnabled(false);
>     actionCopy->setEnabled(false);
> 
>     connect(actionCut, SIGNAL(triggered()), textEdit, SLOT(cut()));
>     connect(actionCopy, SIGNAL(triggered()), textEdit, SLOT(copy()));
>     connect(actionPaste, SIGNAL(triggered()), textEdit, SLOT(paste()));
265,266c131,132
<   connect(textEdit, SIGNAL(copyAvailable(bool)), actionCut, SLOT(setEnabled(bool)));
<   connect(textEdit, SIGNAL(copyAvailable(bool)), actionCopy, SLOT(setEnabled(bool)));
---
>     connect(textEdit, SIGNAL(copyAvailable(bool)), actionCut, SLOT(setEnabled(bool)));
>     connect(textEdit, SIGNAL(copyAvailable(bool)), actionCopy, SLOT(setEnabled(bool)));
269c135
<   connect(QApplication::clipboard(), SIGNAL(dataChanged()), this, SLOT(clipboardDataChanged()));
---
>     connect(QApplication::clipboard(), SIGNAL(dataChanged()), this, SLOT(clipboardDataChanged()));
272,279c138,145
< //  QString initialFile = ":/data/test.txt";
< //  const QStringList args = QCoreApplication::arguments();
< //  if (args.count() == 2)
< //    initialFile = args.at(1);
< 
< //  if (!load(initialFile))
< //    fileNew();
< //  dividePages();
---
> //    QString initialFile = ":/example.html";
>     QString initialFile = ":/fanyiapi.do.xml";
>     const QStringList args = QCoreApplication::arguments();
>     if (args.count() == 2)
>         initialFile = args.at(1);
> 
>     if (!load(initialFile))
>         fileNew();
284,287c150,153
<   if (maybeSave())
<     e->accept();
<   else
<     e->ignore();
---
>     if (maybeSave())
>         e->accept();
>     else
>         e->ignore();
292,330c158,196
<   QToolBar *tb = new QToolBar(this);
<   tb->setWindowTitle(tr("File Actions"));
<   addToolBar(tb);
< 
<   //  QMenu *menu = new QMenu(tr("&File"), this);
<   //  menuBar()->addMenu(menu);
< 
<   QAction *a;
< 
<   QIcon newIcon = QIcon::fromTheme("document-new", QIcon(rsrcPath + "/filenew.png"));
<   a = new QAction( newIcon, tr("&New"), this);
<   a->setPriority(QAction::LowPriority);
<   a->setShortcut(QKeySequence::New);
<   connect(a, SIGNAL(triggered()), this, SLOT(fileNew()));
<   tb->addAction(a);
<   //  menu->addAction(a);
< 
<   a = new QAction(QIcon::fromTheme("document-open", QIcon(rsrcPath + "/fileopen.png")),
<                   tr("&Open..."), this);
<   a->setShortcut(QKeySequence::Open);
<   connect(a, SIGNAL(triggered()), this, SLOT(fileOpen()));
<   tb->addAction(a);
<   //  menu->addAction(a);
< 
<   //  menu->addSeparator();
< 
<   actionSave = a = new QAction(QIcon::fromTheme("document-save", QIcon(rsrcPath + "/filesave.png")),
<                                tr("&Save"), this);
<   a->setShortcut(QKeySequence::Save);
<   connect(a, SIGNAL(triggered()), this, SLOT(fileSave()));
<   a->setEnabled(false);
<   tb->addAction(a);
<   //  menu->addAction(a);
< 
<   a = new QAction(tr("Save &As..."), this);
<   a->setPriority(QAction::LowPriority);
<   connect(a, SIGNAL(triggered()), this, SLOT(fileSaveAs()));
<   //  menu->addAction(a);
<   //  menu->addSeparator();
---
>     QToolBar *tb = new QToolBar(this);
>     tb->setWindowTitle(tr("File Actions"));
>     addToolBar(tb);
> 
>     QMenu *menu = new QMenu(tr("&File"), this);
>     menuBar()->addMenu(menu);
> 
>     QAction *a;
> 
>     QIcon newIcon = QIcon::fromTheme("document-new", QIcon(rsrcPath + "/filenew.png"));
>     a = new QAction( newIcon, tr("&New"), this);
>     a->setPriority(QAction::LowPriority);
>     a->setShortcut(QKeySequence::New);
>     connect(a, SIGNAL(triggered()), this, SLOT(fileNew()));
>     tb->addAction(a);
>     menu->addAction(a);
> 
>     a = new QAction(QIcon::fromTheme("document-open", QIcon(rsrcPath + "/fileopen.png")),
>                     tr("&Open..."), this);
>     a->setShortcut(QKeySequence::Open);
>     connect(a, SIGNAL(triggered()), this, SLOT(fileOpen()));
>     tb->addAction(a);
>     menu->addAction(a);
> 
>     menu->addSeparator();
> 
>     actionSave = a = new QAction(QIcon::fromTheme("document-save", QIcon(rsrcPath + "/filesave.png")),
>                                  tr("&Save"), this);
>     a->setShortcut(QKeySequence::Save);
>     connect(a, SIGNAL(triggered()), this, SLOT(fileSave()));
>     a->setEnabled(false);
>     tb->addAction(a);
>     menu->addAction(a);
> 
>     a = new QAction(tr("Save &As..."), this);
>     a->setPriority(QAction::LowPriority);
>     connect(a, SIGNAL(triggered()), this, SLOT(fileSaveAs()));
>     menu->addAction(a);
>     menu->addSeparator();
333,352c199,218
<   a = new QAction(QIcon::fromTheme("document-print", QIcon(rsrcPath + "/fileprint.png")),
<                   tr("&Print..."), this);
<   a->setPriority(QAction::LowPriority);
<   a->setShortcut(QKeySequence::Print);
<   connect(a, SIGNAL(triggered()), this, SLOT(filePrint()));
<   tb->addAction(a);
<   //  menu->addAction(a);
< 
<   a = new QAction(QIcon::fromTheme("fileprint", QIcon(rsrcPath + "/fileprint.png")),
<                   tr("Print Preview..."), this);
<   connect(a, SIGNAL(triggered()), this, SLOT(filePrintPreview()));
<   //  menu->addAction(a);
< 
<   a = new QAction(QIcon::fromTheme("exportpdf", QIcon(rsrcPath + "/exportpdf.png")),
<                   tr("&Export PDF..."), this);
<   a->setPriority(QAction::LowPriority);
<   a->setShortcut(Qt::CTRL + Qt::Key_D);
<   connect(a, SIGNAL(triggered()), this, SLOT(filePrintPdf()));
<   tb->addAction(a);
<   //  menu->addAction(a);
---
>     a = new QAction(QIcon::fromTheme("document-print", QIcon(rsrcPath + "/fileprint.png")),
>                     tr("&Print..."), this);
>     a->setPriority(QAction::LowPriority);    
>     a->setShortcut(QKeySequence::Print);
>     connect(a, SIGNAL(triggered()), this, SLOT(filePrint()));
>     tb->addAction(a);
>     menu->addAction(a);
> 
>     a = new QAction(QIcon::fromTheme("fileprint", QIcon(rsrcPath + "/fileprint.png")),
>                     tr("Print Preview..."), this);
>     connect(a, SIGNAL(triggered()), this, SLOT(filePrintPreview()));
>     menu->addAction(a);
> 
>     a = new QAction(QIcon::fromTheme("exportpdf", QIcon(rsrcPath + "/exportpdf.png")),
>     tr("&Export PDF..."), this);
>     a->setPriority(QAction::LowPriority);
>     a->setShortcut(Qt::CTRL + Qt::Key_D);
>     connect(a, SIGNAL(triggered()), this, SLOT(filePrintPdf()));
>     tb->addAction(a);
>     menu->addAction(a);
354c220
<   //  menu->addSeparator();
---
>     menu->addSeparator();
357,360c223,226
<   a = new QAction(tr("&Quit"), this);
<   a->setShortcut(Qt::CTRL + Qt::Key_Q);
<   connect(a, SIGNAL(triggered()), this, SLOT(close()));
<   //  menu->addAction(a);
---
>     a = new QAction(tr("&Quit"), this);
>     a->setShortcut(Qt::CTRL + Qt::Key_Q);
>     connect(a, SIGNAL(triggered()), this, SLOT(close()));
>     menu->addAction(a);
365,401c231,267
<   QToolBar *tb = new QToolBar(this);
<   tb->setWindowTitle(tr("Edit Actions"));
<   addToolBar(tb);
<   //  QMenu *menu = new QMenu(tr("&Edit"), this);
<   //  menuBar()->addMenu(menu);
< 
<   QAction *a;
<   a = actionUndo = new QAction(QIcon::fromTheme("edit-undo", QIcon(rsrcPath + "/editundo.png")),
<                                tr("&Undo"), this);
<   a->setShortcut(QKeySequence::Undo);
<   tb->addAction(a);
<   //  menu->addAction(a);
<   a = actionRedo = new QAction(QIcon::fromTheme("edit-redo", QIcon(rsrcPath + "/editredo.png")),
<                                tr("&Redo"), this);
<   a->setPriority(QAction::LowPriority);
<   a->setShortcut(QKeySequence::Redo);
<   tb->addAction(a);
<   //  menu->addAction(a);
<   //  menu->addSeparator();
<   a = actionCut = new QAction(QIcon::fromTheme("edit-cut", QIcon(rsrcPath + "/editcut.png")),
<                               tr("Cu&t"), this);
<   a->setPriority(QAction::LowPriority);
<   a->setShortcut(QKeySequence::Cut);
<   tb->addAction(a);
<   //  menu->addAction(a);
<   a = actionCopy = new QAction(QIcon::fromTheme("edit-copy", QIcon(rsrcPath + "/editcopy.png")),
<                                tr("&Copy"), this);
<   a->setPriority(QAction::LowPriority);
<   a->setShortcut(QKeySequence::Copy);
<   tb->addAction(a);
<   //  menu->addAction(a);
<   a = actionPaste = new QAction(QIcon::fromTheme("edit-paste", QIcon(rsrcPath + "/editpaste.png")),
<                                 tr("&Paste"), this);
<   a->setPriority(QAction::LowPriority);
<   a->setShortcut(QKeySequence::Paste);
<   tb->addAction(a);
<   //  menu->addAction(a);
---
>     QToolBar *tb = new QToolBar(this);
>     tb->setWindowTitle(tr("Edit Actions"));
>     addToolBar(tb);
>     QMenu *menu = new QMenu(tr("&Edit"), this);
>     menuBar()->addMenu(menu);
> 
>     QAction *a;
>     a = actionUndo = new QAction(QIcon::fromTheme("edit-undo", QIcon(rsrcPath + "/editundo.png")),
>                                               tr("&Undo"), this);
>     a->setShortcut(QKeySequence::Undo);
>     tb->addAction(a);
>     menu->addAction(a);
>     a = actionRedo = new QAction(QIcon::fromTheme("edit-redo", QIcon(rsrcPath + "/editredo.png")),
>                                               tr("&Redo"), this);
>     a->setPriority(QAction::LowPriority);
>     a->setShortcut(QKeySequence::Redo);
>     tb->addAction(a);
>     menu->addAction(a);
>     menu->addSeparator();
>     a = actionCut = new QAction(QIcon::fromTheme("edit-cut", QIcon(rsrcPath + "/editcut.png")),
>                                              tr("Cu&t"), this);
>     a->setPriority(QAction::LowPriority);
>     a->setShortcut(QKeySequence::Cut);
>     tb->addAction(a);
>     menu->addAction(a);
>     a = actionCopy = new QAction(QIcon::fromTheme("edit-copy", QIcon(rsrcPath + "/editcopy.png")),
>                                  tr("&Copy"), this);
>     a->setPriority(QAction::LowPriority);
>     a->setShortcut(QKeySequence::Copy);
>     tb->addAction(a);
>     menu->addAction(a);
>     a = actionPaste = new QAction(QIcon::fromTheme("edit-paste", QIcon(rsrcPath + "/editpaste.png")),
>                                   tr("&Paste"), this);
>     a->setPriority(QAction::LowPriority);
>     a->setShortcut(QKeySequence::Paste);
>     tb->addAction(a);
>     menu->addAction(a);
403c269
<   actionPaste->setEnabled(!QApplication::clipboard()->text().isEmpty());
---
>     actionPaste->setEnabled(!QApplication::clipboard()->text().isEmpty());
409,527c275,334
<   QToolBar *tb = new QToolBar(this);
<   tb->setWindowTitle(tr("Format Actions"));
<   addToolBar(tb);
< 
<   //  QMenu *menu = new QMenu(tr("F&ormat"), this);
<   //  menuBar()->addMenu(menu);
< 
<   actionTextBold = new QAction(QIcon::fromTheme("format-text-bold", QIcon(rsrcPath + "/textbold.png")),
<                                tr("&Bold"), this);
<   actionTextBold->setShortcut(Qt::CTRL + Qt::Key_B);
<   actionTextBold->setPriority(QAction::LowPriority);
<   QFont bold;
<   bold.setBold(true);
<   actionTextBold->setFont(bold);
<   connect(actionTextBold, SIGNAL(triggered()), this, SLOT(textBold()));
<   tb->addAction(actionTextBold);
<   //  menu->addAction(actionTextBold);
<   actionTextBold->setCheckable(true);
<   //inifontsize
<   actionTextDump = new QAction(QIcon::fromTheme("format-text-bold", QIcon(rsrcPath + "/textbold.png")),
<                                tr("&Dump"), this);
<   connect(actionTextDump, SIGNAL(triggered()), this, SLOT(dividePages()));
<   tb->addAction(actionTextDump);
<   //  menu->addAction(actionTextDump);
< 
<   actionTextItalic = new QAction(QIcon::fromTheme("format-text-italic", QIcon(rsrcPath + "/textitalic.png")),
<                                  tr("&Italic"), this);
<   actionTextItalic->setPriority(QAction::LowPriority);
<   actionTextItalic->setShortcut(Qt::CTRL + Qt::Key_I);
<   QFont italic;
<   italic.setItalic(true);
<   actionTextItalic->setFont(italic);
<   connect(actionTextItalic, SIGNAL(triggered()), this, SLOT(textItalic()));
<   tb->addAction(actionTextItalic);
<   //  menu->addAction(actionTextItalic);
<   actionTextItalic->setCheckable(true);
< 
<   actionTextUnderline = new QAction(QIcon::fromTheme("format-text-underline", QIcon(rsrcPath + "/textunder.png")),
<                                     tr("&Underline"), this);
<   actionTextUnderline->setShortcut(Qt::CTRL + Qt::Key_U);
<   actionTextUnderline->setPriority(QAction::LowPriority);
<   QFont underline;
<   underline.setUnderline(true);
<   actionTextUnderline->setFont(underline);
<   connect(actionTextUnderline, SIGNAL(triggered()), this, SLOT(textUnderline()));
<   tb->addAction(actionTextUnderline);
<   //  menu->addAction(actionTextUnderline);
<   actionTextUnderline->setCheckable(true);
< 
<   //  menu->addSeparator();
< 
<   QActionGroup *grp = new QActionGroup(this);
<   connect(grp, SIGNAL(triggered(QAction*)), this, SLOT(textAlign(QAction*)));
< 
<   // Make sure the alignLeft  is always left of the alignRight
<   if (QApplication::isLeftToRight()) {
<     actionAlignLeft = new QAction(QIcon::fromTheme("format-justify-left", QIcon(rsrcPath + "/textleft.png")),
<                                   tr("&Left"), grp);
<     actionAlignCenter = new QAction(QIcon::fromTheme("format-justify-center", QIcon(rsrcPath + "/textcenter.png")), tr("C&enter"), grp);
<     actionAlignRight = new QAction(QIcon::fromTheme("format-justify-right", QIcon(rsrcPath + "/textright.png")), tr("&Right"), grp);
<   } else {
<     actionAlignRight = new QAction(QIcon::fromTheme("format-justify-right", QIcon(rsrcPath + "/textright.png")), tr("&Right"), grp);
<     actionAlignCenter = new QAction(QIcon::fromTheme("format-justify-center", QIcon(rsrcPath + "/textcenter.png")), tr("C&enter"), grp);
<     actionAlignLeft = new QAction(QIcon::fromTheme("format-justify-left", QIcon(rsrcPath + "/textleft.png")), tr("&Left"), grp);
<   }
<   actionAlignJustify = new QAction(QIcon::fromTheme("format-justify-fill", QIcon(rsrcPath + "/textjustify.png")), tr("&Justify"), grp);
< 
<   actionAlignLeft->setShortcut(Qt::CTRL + Qt::Key_L);
<   actionAlignLeft->setCheckable(true);
<   actionAlignLeft->setPriority(QAction::LowPriority);
<   actionAlignCenter->setShortcut(Qt::CTRL + Qt::Key_E);
<   actionAlignCenter->setCheckable(true);
<   actionAlignCenter->setPriority(QAction::LowPriority);
<   actionAlignRight->setShortcut(Qt::CTRL + Qt::Key_R);
<   actionAlignRight->setCheckable(true);
<   actionAlignRight->setPriority(QAction::LowPriority);
<   actionAlignJustify->setShortcut(Qt::CTRL + Qt::Key_J);
<   actionAlignJustify->setCheckable(true);
<   actionAlignJustify->setPriority(QAction::LowPriority);
< 
<   tb->addActions(grp->actions());
<   //  menu->addActions(grp->actions());
< 
<   //  menu->addSeparator();
< 
<   QPixmap pix(16, 16);
<   pix.fill(Qt::black);
<   actionTextColor = new QAction(pix, tr("&Color..."), this);
<   connect(actionTextColor, SIGNAL(triggered()), this, SLOT(textColor()));
<   tb->addAction(actionTextColor);
<   //  menu->addAction(actionTextColor);
< 
< 
<   //    tb = new QToolBar(this);
<   //    tb->setAllowedAreas(Qt::TopToolBarArea | Qt::BottomToolBarArea);
<   //    tb->setWindowTitle(tr("Format Actions"));
<   //    addToolBarBreak(Qt::TopToolBarArea);
<   //    addToolBar(tb);
< 
<   //    comboStyle = new QComboBox(tb);
<   //    tb->addWidget(comboStyle);
<   //    comboStyle->addItem("Standard");
<   //    comboStyle->addItem("Bullet List (Disc)");
<   //    comboStyle->addItem("Bullet List (Circle)");
<   //    comboStyle->addItem("Bullet List (Square)");
<   //    comboStyle->addItem("Ordered List (Decimal)");
<   //    comboStyle->addItem("Ordered List (Alpha lower)");
<   //    comboStyle->addItem("Ordered List (Alpha upper)");
<   //    comboStyle->addItem("Ordered List (Roman lower)");
<   //    comboStyle->addItem("Ordered List (Roman upper)");
<   //    connect(comboStyle, SIGNAL(activated(int)),
<   //            this, SLOT(textStyle(int)));
< 
<       comboPn = new QComboBox(tb);
<       comboPn->setObjectName("comboPn");
<       tb->addWidget(comboPn);
<       comboPn->setEditable(true);
< 
< //      QFontDatabase db;
---
>     QToolBar *tb = new QToolBar(this);
>     tb->setWindowTitle(tr("Format Actions"));
>     addToolBar(tb);
> 
>     QMenu *menu = new QMenu(tr("F&ormat"), this);
>     menuBar()->addMenu(menu);
> 
>     actionTextBold = new QAction(QIcon::fromTheme("format-text-bold", QIcon(rsrcPath + "/textbold.png")),
>                                  tr("&Bold"), this);
>     actionTextBold->setShortcut(Qt::CTRL + Qt::Key_B);
>     actionTextBold->setPriority(QAction::LowPriority);
> 	QFont bold;
>     bold.setBold(true);
>     actionTextBold->setFont(bold);
>     connect(actionTextBold, SIGNAL(triggered()), this, SLOT(textBold()));
>     tb->addAction(actionTextBold);
>     menu->addAction(actionTextBold);
>     actionTextBold->setCheckable(true);
> 
>     actionTextItalic = new QAction(QIcon::fromTheme("format-text-italic", QIcon(rsrcPath + "/textitalic.png")),
>                                    tr("&Italic"), this);
>     actionTextItalic->setPriority(QAction::LowPriority);
>     actionTextItalic->setShortcut(Qt::CTRL + Qt::Key_I);
>     QFont italic;
>     italic.setItalic(true);
>     actionTextItalic->setFont(italic);
>     connect(actionTextItalic, SIGNAL(triggered()), this, SLOT(textItalic()));
>     tb->addAction(actionTextItalic);
>     menu->addAction(actionTextItalic);
>     actionTextItalic->setCheckable(true);
> 
>     actionTextUnderline = new QAction(QIcon::fromTheme("format-text-underline", QIcon(rsrcPath + "/textunder.png")),
>                                       tr("&Underline"), this);
>     actionTextUnderline->setShortcut(Qt::CTRL + Qt::Key_U);
>     actionTextUnderline->setPriority(QAction::LowPriority);
>     QFont underline;
>     underline.setUnderline(true);
>     actionTextUnderline->setFont(underline);
>     connect(actionTextUnderline, SIGNAL(triggered()), this, SLOT(textUnderline()));
>     tb->addAction(actionTextUnderline);
>     menu->addAction(actionTextUnderline);
>     actionTextUnderline->setCheckable(true);
> 
>     menu->addSeparator();
> 
>     QActionGroup *grp = new QActionGroup(this);
>     connect(grp, SIGNAL(triggered(QAction*)), this, SLOT(textAlign(QAction*)));
> 
>     // Make sure the alignLeft  is always left of the alignRight
>     if (QApplication::isLeftToRight()) {
>         actionAlignLeft = new QAction(QIcon::fromTheme("format-justify-left", QIcon(rsrcPath + "/textleft.png")),
>                                       tr("&Left"), grp);
>         actionAlignCenter = new QAction(QIcon::fromTheme("format-justify-center", QIcon(rsrcPath + "/textcenter.png")), tr("C&enter"), grp);
>         actionAlignRight = new QAction(QIcon::fromTheme("format-justify-right", QIcon(rsrcPath + "/textright.png")), tr("&Right"), grp);
>     } else {
>         actionAlignRight = new QAction(QIcon::fromTheme("format-justify-right", QIcon(rsrcPath + "/textright.png")), tr("&Right"), grp);
>         actionAlignCenter = new QAction(QIcon::fromTheme("format-justify-center", QIcon(rsrcPath + "/textcenter.png")), tr("C&enter"), grp);
>         actionAlignLeft = new QAction(QIcon::fromTheme("format-justify-left", QIcon(rsrcPath + "/textleft.png")), tr("&Left"), grp);
>     }
>     actionAlignJustify = new QAction(QIcon::fromTheme("format-justify-fill", QIcon(rsrcPath + "/textjustify.png")), tr("&Justify"), grp);
529,530c336,399
<       connect(comboPn, SIGNAL(activated(QString)),
<               this, SLOT(pageChanged(QString)));
---
>     actionAlignLeft->setShortcut(Qt::CTRL + Qt::Key_L);
>     actionAlignLeft->setCheckable(true);
>     actionAlignLeft->setPriority(QAction::LowPriority);
>     actionAlignCenter->setShortcut(Qt::CTRL + Qt::Key_E);
>     actionAlignCenter->setCheckable(true);
>     actionAlignCenter->setPriority(QAction::LowPriority);
>     actionAlignRight->setShortcut(Qt::CTRL + Qt::Key_R);
>     actionAlignRight->setCheckable(true);
>     actionAlignRight->setPriority(QAction::LowPriority);
>     actionAlignJustify->setShortcut(Qt::CTRL + Qt::Key_J);
>     actionAlignJustify->setCheckable(true);
>     actionAlignJustify->setPriority(QAction::LowPriority);
> 
>     tb->addActions(grp->actions());
>     menu->addActions(grp->actions());
> 
>     menu->addSeparator();
> 
>     QPixmap pix(16, 16);
>     pix.fill(Qt::black);
>     actionTextColor = new QAction(pix, tr("&Color..."), this);
>     connect(actionTextColor, SIGNAL(triggered()), this, SLOT(textColor()));
>     tb->addAction(actionTextColor);
>     menu->addAction(actionTextColor);
> 
> 
>     tb = new QToolBar(this);
>     tb->setAllowedAreas(Qt::TopToolBarArea | Qt::BottomToolBarArea);
>     tb->setWindowTitle(tr("Format Actions"));
>     addToolBarBreak(Qt::TopToolBarArea);
>     addToolBar(tb);
> 
>     comboStyle = new QComboBox(tb);
>     tb->addWidget(comboStyle);
>     comboStyle->addItem("Standard");
>     comboStyle->addItem("Bullet List (Disc)");
>     comboStyle->addItem("Bullet List (Circle)");
>     comboStyle->addItem("Bullet List (Square)");
>     comboStyle->addItem("Ordered List (Decimal)");
>     comboStyle->addItem("Ordered List (Alpha lower)");
>     comboStyle->addItem("Ordered List (Alpha upper)");
>     comboStyle->addItem("Ordered List (Roman lower)");
>     comboStyle->addItem("Ordered List (Roman upper)");
>     connect(comboStyle, SIGNAL(activated(int)),
>             this, SLOT(textStyle(int)));
> 
>     comboFont = new QFontComboBox(tb);
>     tb->addWidget(comboFont);
>     connect(comboFont, SIGNAL(activated(QString)),
>             this, SLOT(textFamily(QString)));
> 
>     comboSize = new QComboBox(tb);
>     comboSize->setObjectName("comboSize");
>     tb->addWidget(comboSize);
>     comboSize->setEditable(true);
> 
>     QFontDatabase db;
>     foreach(int size, db.standardSizes())
>         comboSize->addItem(QString::number(size));
> 
>     connect(comboSize, SIGNAL(activated(QString)),
>             this, SLOT(textSize(QString)));
>     comboSize->setCurrentIndex(comboSize->findText(QString::number(QApplication::font()
>                                                                    .pointSize())));
535,562c404,455
<   cout<<"textedit.load:"<<f;
<   if (!QFile::exists(f)){
<     cout<<"textedit.load:not exists"<<f;
<     return false;
<   }
<   QFile file(f);
<   if (!file.open(QFile::ReadOnly))
<     return false;
< 
<   QByteArray data = file.readAll();
<   QTextCodec *codec = Qt::codecForHtml(data);
<   QString str = codec->toUnicode(data);
<   if (Qt::mightBeRichText(str)) {
<     cout<<"textedit.load:";
<     textEdit->setHtml(str);
<   } else {
<     str = QString::fromLocal8Bit(data);
<     textEdit->setPlainText(str);
<   }
<   setCurrentFileName(f);
<   docs.clear();
<   cout<<"textedit ajust";
<   textEdit->adjustSize();
<   textEdit->autoFormatting();
<   textEdit->setVisible(true);
<   textEdit->activateWindow();
<   dividePages();
<   return true;
---
> //    if (!QFile::exists(f))
> //        return false;
>     QFile file(f);
> //    if (!file.open(QFile::ReadOnly))
> //        return false;
> 
> 
>     QDomDocument doc("test");
>     if ( !file.open(QIODevice::ReadOnly) ) {
>    //     qDebug() << tr("second stage");
>             return false;
>     }
>     if ( !doc.setContent(&file) )
>     {
>         file.close();
>  //       qDebug() << tr("third stage");
>         return false;
>     }
>     file.close();
>     //显示查询的单词
>     QDomNodeList list = doc.elementsByTagName("query");
>     textEdit->append( list.at(0).toElement().text());
>     //进入基本释义节点
>     list = doc.elementsByTagName("basic");
>     QDomElement n = list.at(0).toElement();
>     //音标
>     list = n.elementsByTagName("phonetic");
>     for ( int i = 0; i < list.count(); i++ ) {
>         textEdit->append( QObject::tr(list.at(i).toElement().text().toLatin1().data()));
>     }
>     //解释
>     list = n.elementsByTagName("ex");
>     for ( int i = 0; i < list.count(); i++ ) {
>         textEdit->append( list.at(i).toElement().text());
>     }
> 
> 
> 
> //        QByteArray data = file.readAll();
> //    //data = QObject::tr(data.toLatin1().data());
> //    QTextCodec *codec = Qt::codecForHtml(data);
> //    QString str = codec->toUnicode(data);
> //    str = QObject::tr(str.toLatin1().data());
> //    if (Qt::mightBeRichText(str)) {
> //        textEdit->setHtml(str);
> //    } else {
> //        str = QString::fromLocal8Bit(data);
> //        textEdit->setPlainText(str);
> //    }
> 
>     setCurrentFileName(f);
>     return true;
567,569c460,473
<   if (!textEdit->document()->isModified())
<     return true;
<   if (fileName.startsWith(QLatin1String(":/")))
---
>     if (!textEdit->document()->isModified())
>         return true;
>     if (fileName.startsWith(QLatin1String(":/")))
>         return true;
>     QMessageBox::StandardButton ret;
>     ret = QMessageBox::warning(this, tr("Application"),
>                                tr("The document has been modified.\n"
>                                   "Do you want to save your changes?"),
>                                QMessageBox::Save | QMessageBox::Discard
>                                | QMessageBox::Cancel);
>     if (ret == QMessageBox::Save)
>         return fileSave();
>     else if (ret == QMessageBox::Cancel)
>         return false;
571,581d474
<   QMessageBox::StandardButton ret;
<   ret = QMessageBox::warning(this, tr("Application"),
<                              tr("The document has been modified.\n"
<                                 "Do you want to save your changes?"),
<                              QMessageBox::Save | QMessageBox::Discard
<                              | QMessageBox::Cancel);
<   if (ret == QMessageBox::Save)
<     return fileSave();
<   else if (ret == QMessageBox::Cancel)
<     return false;
<   return true;
586,587c479,480
<   this->fileName = fileName;
<   textEdit->document()->setModified(false);
---
>     this->fileName = fileName;
>     textEdit->document()->setModified(false);
589,593c482,486
<   QString shownName;
<   if (fileName.isEmpty())
<     shownName = "untitled.txt";
<   else
<     shownName = QFileInfo(fileName).fileName();
---
>     QString shownName;
>     if (fileName.isEmpty())
>         shownName = "untitled.txt";
>     else
>         shownName = QFileInfo(fileName).fileName();
595,596c488,489
<   setWindowTitle(tr("%1[*] - %2").arg(shownName).arg(tr("Rich Text")));
<   setWindowModified(false);
---
>     setWindowTitle(tr("%1[*] - %2").arg(shownName).arg(tr("Rich Text")));
>     setWindowModified(false);
601,604c494,497
<   if (maybeSave()) {
<     textEdit->clear();
<     setCurrentFileName(QString());
<   }
---
>     if (maybeSave()) {
>         textEdit->clear();
>         setCurrentFileName(QString());
>     }
609,614c502,505
<   QString fn = QFileDialog::getOpenFileName(this, tr("Open File..."),
<                                             //QString(), tr("HTML-Files (*.htm *.html);;Al Files (*)"));
<                                             QString(), tr("TEXT-Files (*.txt);;Al Files (*)"));
<   cout<<"TextEdit.fileOPen:"<<fn;
<   if (!fn.isEmpty())
<     load(fn);
---
>     QString fn = QFileDialog::getOpenFileName(this, tr("Open File..."),
>                                               QString(), tr("HTML-Files (*.htm *.html);;All Files (*)"));
>     if (!fn.isEmpty())
>         load(fn);
619,620c510,511
<   if (fileName.isEmpty())
<     return fileSaveAs();
---
>     if (fileName.isEmpty())
>         return fileSaveAs();
622,626c513,517
<   QTextDocumentWriter writer(fileName);
<   bool success = writer.write(textEdit->document());
<   if (success)
<     textEdit->document()->setModified(false);
<   return success;
---
>     QTextDocumentWriter writer(fileName);
>     bool success = writer.write(textEdit->document());
>     if (success)
>         textEdit->document()->setModified(false);
>     return success;
631,638c522,529
<   QString fn = QFileDialog::getSaveFileName(this, tr("Save as..."),
<                                             QString(), tr("ODF files (*.odt);;HTML-Files (*.htm *.html);;All Files (*)"));
<   if (fn.isEmpty())
<     return false;
<   if (! (fn.endsWith(".odt", Qt::CaseInsensitive) || fn.endsWith(".htm", Qt::CaseInsensitive) || fn.endsWith(".html", Qt::CaseInsensitive)) )
<     fn += ".odt"; // default
<   setCurrentFileName(fn);
<   return fileSave();
---
>     QString fn = QFileDialog::getSaveFileName(this, tr("Save as..."),
>                                               QString(), tr("ODF files (*.odt);;HTML-Files (*.htm *.html);;All Files (*)"));
>     if (fn.isEmpty())
>         return false;
>     if (! (fn.endsWith(".odt", Qt::CaseInsensitive) || fn.endsWith(".htm", Qt::CaseInsensitive) || fn.endsWith(".html", Qt::CaseInsensitive)) )
>         fn += ".odt"; // default
>     setCurrentFileName(fn);
>     return fileSave();
644,652c535,543
<   QPrinter printer(QPrinter::HighResolution);
<   QPrintDialog *dlg = new QPrintDialog(&printer, this);
<   if (textEdit->textCursor().hasSelection())
<     dlg->addEnabledOption(QAbstractPrintDialog::PrintSelection);
<   dlg->setWindowTitle(tr("Print Document"));
<   if (dlg->exec() == QDialog::Accepted) {
<     textEdit->print(&printer);
<   }
<   delete dlg;
---
>     QPrinter printer(QPrinter::HighResolution);
>     QPrintDialog *dlg = new QPrintDialog(&printer, this);
>     if (textEdit->textCursor().hasSelection())
>         dlg->addEnabledOption(QAbstractPrintDialog::PrintSelection);
>     dlg->setWindowTitle(tr("Print Document"));
>     if (dlg->exec() == QDialog::Accepted) {
>         textEdit->print(&printer);
>     }
>     delete dlg;
659,662c550,553
<   QPrinter printer(QPrinter::HighResolution);
<   QPrintPreviewDialog preview(&printer, this);
<   connect(&preview, SIGNAL(paintRequested(QPrinter*)), SLOT(printPreview(QPrinter*)));
<   preview.exec();
---
>     QPrinter printer(QPrinter::HighResolution);
>     QPrintPreviewDialog preview(&printer, this);
>     connect(&preview, SIGNAL(paintRequested(QPrinter*)), SLOT(printPreview(QPrinter*)));
>     preview.exec();
669c560
<   Q_UNUSED(printer);
---
>     Q_UNUSED(printer);
671c562
<   textEdit->print(printer);
---
>     textEdit->print(printer);
679,690c570,581
<   //! [0]
<   QString fileName = QFileDialog::getSaveFileName(this, "Export PDF",
<                                                   QString(), "*.pdf");
<   if (!fileName.isEmpty()) {
<     if (QFileInfo(fileName).suffix().isEmpty())
<       fileName.append(".pdf");
<     QPrinter printer(QPrinter::HighResolution);
<     printer.setOutputFormat(QPrinter::PdfFormat);
<     printer.setOutputFileName(fileName);
<     textEdit->document()->print(&printer);
<   }
<   //! [0]
---
> //! [0]
>     QString fileName = QFileDialog::getSaveFileName(this, "Export PDF",
>                                                     QString(), "*.pdf");
>     if (!fileName.isEmpty()) {
>         if (QFileInfo(fileName).suffix().isEmpty())
>             fileName.append(".pdf");
>         QPrinter printer(QPrinter::HighResolution);
>         printer.setOutputFormat(QPrinter::PdfFormat);
>         printer.setOutputFileName(fileName);
>         textEdit->document()->print(&printer);
>     }
> //! [0]
696,698c587,589
<   QTextCharFormat fmt;
<   fmt.setFontWeight(actionTextBold->isChecked() ? QFont::Bold : QFont::Normal);
<   mergeFormatOnWordOrSelection(fmt);
---
>     QTextCharFormat fmt;
>     fmt.setFontWeight(actionTextBold->isChecked() ? QFont::Bold : QFont::Normal);
>     mergeFormatOnWordOrSelection(fmt);
703,705c594,596
<   QTextCharFormat fmt;
<   fmt.setFontUnderline(actionTextUnderline->isChecked());
<   mergeFormatOnWordOrSelection(fmt);
---
>     QTextCharFormat fmt;
>     fmt.setFontUnderline(actionTextUnderline->isChecked());
>     mergeFormatOnWordOrSelection(fmt);
710,712c601,603
<   QTextCharFormat fmt;
<   fmt.setFontItalic(actionTextItalic->isChecked());
<   mergeFormatOnWordOrSelection(fmt);
---
>     QTextCharFormat fmt;
>     fmt.setFontItalic(actionTextItalic->isChecked());
>     mergeFormatOnWordOrSelection(fmt);
717,719c608,610
<   QTextCharFormat fmt;
<   fmt.setFontFamily(f);
<   mergeFormatOnWordOrSelection(fmt);
---
>     QTextCharFormat fmt;
>     fmt.setFontFamily(f);
>     mergeFormatOnWordOrSelection(fmt);
724,731c615,620
<   qreal pointSize = p.toFloat();
<   if (p.toFloat() > 0) {
<     cout<<"textedit.textsize:"<<p;
<     QTextCharFormat fmt;
<     //fmt.setFontPointSize(pointSize);
<     fmt.setFontPointSize(FONTSIZE);
<     mergeFormatOnWordOrSelection(fmt);
<   }
---
>     qreal pointSize = p.toFloat();
>     if (p.toFloat() > 0) {
>         QTextCharFormat fmt;
>         fmt.setFontPointSize(pointSize);
>         mergeFormatOnWordOrSelection(fmt);
>     }
736,739c625
<   QTextCursor cursor = textEdit->textCursor();
< 
<   if (styleIndex != 0) {
<     QTextListFormat::Style style = QTextListFormat::ListDisc;
---
>     QTextCursor cursor = textEdit->textCursor();
741,767c627,628
<     switch (styleIndex) {
<     default:
<     case 1:
<       style = QTextListFormat::ListDisc;
<       break;
<     case 2:
<       style = QTextListFormat::ListCircle;
<       break;
<     case 3:
<       style = QTextListFormat::ListSquare;
<       break;
<     case 4:
<       style = QTextListFormat::ListDecimal;
<       break;
<     case 5:
<       style = QTextListFormat::ListLowerAlpha;
<       break;
<     case 6:
<       style = QTextListFormat::ListUpperAlpha;
<       break;
<     case 7:
<       style = QTextListFormat::ListLowerRoman;
<       break;
<     case 8:
<       style = QTextListFormat::ListUpperRoman;
<       break;
<     }
---
>     if (styleIndex != 0) {
>         QTextListFormat::Style style = QTextListFormat::ListDisc;
769c630,670
<     cursor.beginEditBlock();
---
>         switch (styleIndex) {
>             default:
>             case 1:
>                 style = QTextListFormat::ListDisc;
>                 break;
>             case 2:
>                 style = QTextListFormat::ListCircle;
>                 break;
>             case 3:
>                 style = QTextListFormat::ListSquare;
>                 break;
>             case 4:
>                 style = QTextListFormat::ListDecimal;
>                 break;
>             case 5:
>                 style = QTextListFormat::ListLowerAlpha;
>                 break;
>             case 6:
>                 style = QTextListFormat::ListUpperAlpha;
>                 break;
>             case 7:
>                 style = QTextListFormat::ListLowerRoman;
>                 break;
>             case 8:
>                 style = QTextListFormat::ListUpperRoman;
>                 break;
>         }
> 
>         cursor.beginEditBlock();
> 
>         QTextBlockFormat blockFmt = cursor.blockFormat();
> 
>         QTextListFormat listFmt;
> 
>         if (cursor.currentList()) {
>             listFmt = cursor.currentList()->format();
>         } else {
>             listFmt.setIndent(blockFmt.indent() + 1);
>             blockFmt.setIndent(0);
>             cursor.setBlockFormat(blockFmt);
>         }
771c672
<     QTextBlockFormat blockFmt = cursor.blockFormat();
---
>         listFmt.setStyle(style);
773c674
<     QTextListFormat listFmt;
---
>         cursor.createList(listFmt);
775,776c676
<     if (cursor.currentList()) {
<       listFmt = cursor.currentList()->format();
---
>         cursor.endEditBlock();
778,793c678,682
<       listFmt.setIndent(blockFmt.indent() + 1);
<       blockFmt.setIndent(0);
<       cursor.setBlockFormat(blockFmt);
<     }
< 
<     listFmt.setStyle(style);
< 
<     cursor.createList(listFmt);
< 
<     cursor.endEditBlock();
<   } else {
<     // ####
<     QTextBlockFormat bfmt;
<     bfmt.setObjectIndex(-1);
<     cursor.mergeBlockFormat(bfmt);
<   }
---
>         // ####
>         QTextBlockFormat bfmt;
>         bfmt.setObjectIndex(-1);
>         cursor.mergeBlockFormat(bfmt);
>     }
798,804c687,693
<   QColor col = QColorDialog::getColor(textEdit->textColor(), this);
<   if (!col.isValid())
<     return;
<   QTextCharFormat fmt;
<   fmt.setForeground(col);
<   mergeFormatOnWordOrSelection(fmt);
<   colorChanged(col);
---
>     QColor col = QColorDialog::getColor(textEdit->textColor(), this);
>     if (!col.isValid())
>         return;
>     QTextCharFormat fmt;
>     fmt.setForeground(col);
>     mergeFormatOnWordOrSelection(fmt);
>     colorChanged(col);
809,816c698,705
<   if (a == actionAlignLeft)
<     textEdit->setAlignment(Qt::AlignLeft | Qt::AlignAbsolute);
<   else if (a == actionAlignCenter)
<     textEdit->setAlignment(Qt::AlignHCenter);
<   else if (a == actionAlignRight)
<     textEdit->setAlignment(Qt::AlignRight | Qt::AlignAbsolute);
<   else if (a == actionAlignJustify)
<     textEdit->setAlignment(Qt::AlignJustify);
---
>     if (a == actionAlignLeft)
>         textEdit->setAlignment(Qt::AlignLeft | Qt::AlignAbsolute);
>     else if (a == actionAlignCenter)
>         textEdit->setAlignment(Qt::AlignHCenter);
>     else if (a == actionAlignRight)
>         textEdit->setAlignment(Qt::AlignRight | Qt::AlignAbsolute);
>     else if (a == actionAlignJustify)
>         textEdit->setAlignment(Qt::AlignJustify);
821,826c710,711
<   fontChanged(format.font());
<   colorChanged(format.foreground().color());
< }
< 
< void printPoint(QPointF p){
<   cout<<p.x()<<","<<p.y();
---
>     fontChanged(format.font());
>     colorChanged(format.foreground().color());
829,859d713
< //get the line from block[textStart] to block[textEnd]
< QLine getLine(QTextBlock *block, int textStart,int textEnd){
<   int blockStart=block->position();
<   QTextLayout* layout=block->layout();
<   QPoint blockOffset=layout->position().toPoint();
<   QTextLine layoutLine=layout->lineForTextPosition(textStart-blockStart);
<   int lineHeight=layoutLine.naturalTextRect().height();
<   QPoint lineOffset=layoutLine.position().toPoint();
<   int lineTextStart=blockStart+layoutLine.textStart();
<   int lineTextEnd=lineTextStart+layoutLine.textLength();
<   int lineWidth=layoutLine.naturalTextWidth();
<   int x0=blockOffset.x()+lineOffset.x()+((float)(textStart-lineTextStart)/(lineTextEnd-lineTextStart)*lineWidth);
<   int y0=blockOffset.y()+lineOffset.y()+lineHeight;
<   int x1=blockOffset.x()+lineOffset.x()+((float)(textEnd-lineTextStart)/(lineTextEnd-lineTextStart)*lineWidth);
<   QPoint linePoint(x0,y0);
<   QPoint lineEndPoint=QPoint(x1,y0);
<   return QLine(linePoint,lineEndPoint);
< }
< 
< //for debug only
< void printLines(QTextBlock *block){
<   cout<<"#printlines";
<   cout<<block->text();
<   QTextLayout* layout=block->layout();
<   for(int i=0;i<layout->lineCount();i++){
<     QTextLine layoutLine=layout->lineAt(i);
<     int s=layoutLine.textStart(),t=s+layoutLine.textLength();
<     cout<<layoutLine.lineNumber()<<":"<<s<<","<<t;
<     cout<<block->text().mid(s,t-s);
<   }
< }
862,907c716
<   //alignmentChanged(textEdit->alignment());
< 
<   cout<<"#TextEdit::cursorPositionChanged:";
< 
<   QColor col = Qt::gray;
<   QTextCharFormat fmt;
<   fmt.setForeground(col);
<   QTextCursor cursor = textEdit->textCursor();
<   cursor.mergeCharFormat(fmt);
<   colorChanged(col);
< 
<   int selectionStart=cursor.selectionStart(),
<       selectionEnd=cursor.selectionEnd();
<   cout<<"selection start and end:"<<selectionStart<<","<<selectionEnd;
< 
<   //pages not divided yet
<   if(lines.size()<1) return;
<   //if(!cursor.hasSelection()) return;
< 
<   int textStart=selectionStart,textEnd=selectionEnd;
<   QTextDocument* doc=textEdit->document();
<   QTextBlock block=cursor.block();
<   int a=textStart-1,b=a;
<   while(b<textEnd){
<     printLines(&block);
<     int blockStart=block.position();
<     int blockEnd=blockStart+block.length();
<     if(textStart>textEnd) return;
<     QTextLayout* layout=block.layout();
<     while(b<textEnd&&b<blockEnd-1){
<       a=b+1;
<       QTextLine layoutLine=layout->lineForTextPosition(a-blockStart);
<       //if(!layoutLine.isValid()) continue;
<       int lineTextStart=blockStart+layoutLine.textStart();
<       int lineTextEnd=lineTextStart+layoutLine.textLength();
<       b=MIN(textEnd,lineTextEnd);
<       //draw the highlight line on the canvas
<       QLine line=getLine(&block,a,b);
<       canvas->paintLine(line);
<       lines[curPn].push_back(line);
<     }
<     if(textEnd>b){
<       block=block.next();
<       b=block.position();
<     }
<   }
---
>     alignmentChanged(textEdit->alignment());
908a718
> 
912c722
<   actionPaste->setEnabled(!QApplication::clipboard()->text().isEmpty());
---
>     actionPaste->setEnabled(!QApplication::clipboard()->text().isEmpty());
918,920c728,730
<   QMessageBox::about(this, tr("About"), tr("This example demonstrates Qt's "
<                                            "rich text editing facilities in action, providing an example "
<                                            "document for you to experiment with."));
---
>     QMessageBox::about(this, tr("About"), tr("This example demonstrates Qt's "
>         "rich text editing facilities in action, providing an example "
>         "document for you to experiment with."));
925,930c735,739
<   QTextCursor cursor = textEdit->textCursor();
<   if (!cursor.hasSelection())
<     cursor.select(QTextCursor::WordUnderCursor);
<   cout<<"TextEdit.mergeFormat..:"<<cursor.selectionStart()<<","<<cursor.selectionEnd();
<   cursor.mergeCharFormat(format);
<   textEdit->mergeCurrentCharFormat(format);
---
>     QTextCursor cursor = textEdit->textCursor();
>     if (!cursor.hasSelection())
>         cursor.select(QTextCursor::WordUnderCursor);
>     cursor.mergeCharFormat(format);
>     textEdit->mergeCurrentCharFormat(format);
935,939c744,748
<   //  comboFont->setCurrentIndex(comboFont->findText(QFontInfo(f).family()));
<   //comboSize->setCurrentIndex(comboSize->findText(QString::number(f.pointSize())));
<   actionTextBold->setChecked(f.bold());
<   actionTextItalic->setChecked(f.italic());
<   actionTextUnderline->setChecked(f.underline());
---
>     comboFont->setCurrentIndex(comboFont->findText(QFontInfo(f).family()));
>     comboSize->setCurrentIndex(comboSize->findText(QString::number(f.pointSize())));
>     actionTextBold->setChecked(f.bold());
>     actionTextItalic->setChecked(f.italic());
>     actionTextUnderline->setChecked(f.underline());
944,946c753,755
<   QPixmap pix(16, 16);
<   pix.fill(c);
<   actionTextColor->setIcon(pix);
---
>     QPixmap pix(16, 16);
>     pix.fill(c);
>     actionTextColor->setIcon(pix);
951,959c760,768
<   if (a & Qt::AlignLeft) {
<     actionAlignLeft->setChecked(true);
<   } else if (a & Qt::AlignHCenter) {
<     actionAlignCenter->setChecked(true);
<   } else if (a & Qt::AlignRight) {
<     actionAlignRight->setChecked(true);
<   } else if (a & Qt::AlignJustify) {
<     actionAlignJustify->setChecked(true);
<   }
---
>     if (a & Qt::AlignLeft) {
>         actionAlignLeft->setChecked(true);
>     } else if (a & Qt::AlignHCenter) {
>         actionAlignCenter->setChecked(true);
>     } else if (a & Qt::AlignRight) {
>         actionAlignRight->setChecked(true);
>     } else if (a & Qt::AlignJustify) {
>         actionAlignJustify->setChecked(true);
>     }
960a770
> 
